{% extends 'admin/base_site.html' %}

{% block content %}
<div id="content-main">
    <h2>Send Command to Queue</h2>
    <div id="message-area" style="color: green; margin-bottom: 10px;"></div>
    <form id="send-command-form" action="{% url 'admin:send_command' %}" method="post">
        {% csrf_token %}
        <h2>Command Log</h2>
    <div id="command-log" style="background-color: #f0f0f0; padding: 10px; border: 1px solid #ccc; height: 300px; overflow-y: scroll; font-family: monospace; white-space: pre-wrap;"></div>
        <p>{{ form.agent.label_tag }} {{ form.agent }}</p>
        <p>{{ form.command.label_tag }} {{ form.command }}</p>
        <input type="submit" value="Send Command">
    </form>

</div>

<script>
    document.getElementById('send-command-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const messageArea = document.getElementById('message-area');
                messageArea.textContent = data.message;
                setTimeout(() => messageArea.textContent = '', 3000); // Clear message after 3 seconds
                document.getElementById('id_command').value = ''; // Clear the command input
                document.getElementById('id_command').focus();   // Refocus the command input
                fetchCommandLog(); // Refresh the log
            }
        })
        .catch(error => console.error('Error sending command:', error));
    });

    function fetchCommandLog(agentId = null) {
        let url = '{% url "admin:command_log_api" %}';
        if (agentId) {
            url += `?agent_id=${agentId}`;
        }
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const logDiv = document.getElementById('command-log');
                logDiv.innerHTML = ''; // Clear existing log
                data.perceptions.reverse().forEach(p => {
                    const perceptionText = p.type === 'command' 
                        ? `${p.agent_name}>${p.command_text}
${p.text}` 
                        : `${p.text}`;
                    const paragraph = document.createElement('p');
                    paragraph.textContent = perceptionText;
                    logDiv.appendChild(paragraph);
                });
                logDiv.scrollTop = logDiv.scrollHeight; // Scroll to bottom
            })
            .catch(error => console.error('Error fetching command log:', error));
    }

    // Get the agent select element
    const agentSelect = document.getElementById('id_agent'); // Assuming the ID of the select element is 'id_agent'

    // Add event listener for when the agent selection changes
    if (agentSelect) {
        agentSelect.addEventListener('change', (event) => {
            const selectedAgentId = event.target.value;
            fetchCommandLog(selectedAgentId);
        });
    }

    // Fetch log initially for the currently selected agent (if any)
    fetchCommandLog(agentSelect ? agentSelect.value : null);
    setInterval(() => fetchCommandLog(agentSelect ? agentSelect.value : null), 3000);
</script>
{% endblock %}